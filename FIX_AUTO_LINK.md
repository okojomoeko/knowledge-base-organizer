# Auto-Link機能の修正計画

## 1. 目的 (Objective)

`auto-link`機能を、ファイルの構造を破壊することなく、安全かつ正確に実行できるように修正する。意図しない箇所へのリンク生成を防ぎ、機能の信頼性を向上させる。

## 2. 問題点 (Issues)

現在、`auto-link`コマンドを実行すると、以下の破壊的な変更や意図しない動作が確認されている。

1.  **Frontmatterの完全な削除**
    - **現象:** 処理後、対象ファイルのFrontmatterブロック(`---...---`)が完全に削除される。
    - **影響:** ファイルのメタデータが全て失われる、極めて重大なバグ。

2.  **自己参照タイトルの不要なリンク化**
    - **現象:** ファイルのH1見出し（例: `# My Title`）が、自己参照のWikiLink（`# [[My Title]]`）に変換される。
    - **影響:** 冗長であり、可読性を損なう。

3.  **HTMLリンクの破壊**
    - **現象:** `<a>`タグのリンクテキスト部分がWikiLinkに置換され、HTML構文が壊れる。（例: `<a href="...">[[Some Link Text]]</a>`）
    - **影響:** リンクが正しく表示・機能しなくなる。

## 3. 現状分析 (Current Analysis)

これらの問題は、`auto-link`機能がコンテンツを置換する際に、処理すべきでない「保護領域（除外ゾーン）」の判定が不十分であることに起因する。

-   **Frontmatter削除:** ファイルの本文（Body）とFrontmatterを分離せずに、ファイル全体を単一のテキストとして処理している可能性が高い。Frontmatterを安全に再構築する処理がワークフローに欠けている。
-   **H1見出し & HTMLリンク:** `LinkAnalysisService`の`extract_exclusion_zones`メソッドが、H1見出しやHTMLタグを除外対象として定義していない。

## 4. やるべきこと (To-Do)

### 最優先 (Top Priority)

- [ ] **Frontmatter削除問題の修正**
    - `AutoLinkGenerationUseCase`の処理フローを調査する。
    - ファイル読み込み後、本文（Body）のみをリンク置換の対象とし、処理後に`FileRepository`の機能を使ってFrontmatterと本文を安全に再結合して保存するように修正する。

### 次のステップ (Next Steps)

- [ ] **除外ゾーンの拡張**
    - `LinkAnalysisService`の`extract_exclusion_zones`メソッドを修正する。
    - H1見出し（行頭の`# `）を除外ゾーンに追加するロジックを実装する。
    - HTMLタグ（特に`<a>...</a>`）を除外ゾーンに追加するロジックを実装する。

- [ ] **テストの追加**
    - 上記3つの問題が修正されたことを検証するテストケースを作成・追加する。
    - Frontmatterが保持されること、H1見出しがリンク化されないこと、HTMLタグ内が変更されないことを確認するテストを実装する。
