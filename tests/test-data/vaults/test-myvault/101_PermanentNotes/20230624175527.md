---
title: Amazon CloudWatch
aliases: [CloudWatch,cloudwatch]
tags: [aws/management-governance/cloudwatch,dva]
id:  20230624175527
date: 2023-06-24
publish: false
---

# Amazon CloudWatch

- 統合的な運用監視サービス

## 機能

- [[20230816202421|CloudWatch Logs]]
- [[20240314205715|CloudWatch Events]]
- [[CloudWatch Alarms]]
- [[CloudWatch Logs Insights]]
- [[CloudWatch Dashboards]]

## [[CloudWatch Alarms]]

- メトリクスを監視して、事前に定義されたしきい値に基づいてアクションをトリガー可能
    - [[機械学習]] による異常検知も対応
- [[20230816200310|EventBridge]]との違いは？
    - [[20230816200310|EventBridge]]はパターンマッチング型のイベント駆動なので、なにかアラームを起こすためのルールを作る必要がある
        - 例えば、[[20230805235856|Lambda]]関数でエラーを取得するためのカスタムルールなど
- [[複合アラーム(Composite Alarm)]]
    - すでに作成されているアラームの組み合わせの状態を監視対象にできるアラーム
        - メモリ消費率80%のアラーム AND ディスク消費量70% のアラームならば`TRUE`とか
    - [CloudWatchの複合アラームを仕組みを確認しつつ使ってみた \| DevelopersIO](https://dev.classmethod.jp/articles/i-tried-using-cloudwatchs-composite-alarm-while-checking-how-it-works/)

### アラームアクション

- アラームに対してアクションを設定できる
    - [[20230727234718|EC2]] 自動復旧とか

## ユースケース

### 3層構造のWebアプリケーションの[[メトリクス]]

[[20230727234718|EC2]]、[[20230730201034|ELB]]、[[20230802000730|RDS]]などで構成された[[3層構造]]のwebアプリケーションを考える。

アプリケーションを構築したとき、[[20230730201034|ELB]]のログには下記のようなものが登録される

- HTTPCode_ELB_5XX ... ロードバランサーまたは登録されたインスタンスがエラー
- HTTPCode_ELB_4XX ... 登録済みインスタンスからクライアントエラー応答が送信されたとき
    - リクエストするクライアント側の問題
- HTTPCode_ELB_3XX ... 登録済みインスタンスからリダイレクト応答が送信されたとき
    - リクエストの完了に追加処理が必要である状態・問題

### クロスリージョンでダッシュボードを見る

- 1つのアカウントに対しては、普通にナビゲーションバーから[[リージョン]]を選択して切り替えるだけ。特に設定はいらない。

- ただし、[[20240227235831|EC2インスタンス]]などの詳細な情報を得るための[[CloudWatch Agent]]を使う場合は設定が必要になる。
    - [[CloudWatch Agent]]では、`append_dimensions`フィールドを追加してカスタムディメンションを追加できる
    - `aws ec2 monitor-instances --instance-ids i-xxxxxxxxx`でモニタリング設定を行うので注意(`logs`とかではない)

[CloudWatch エージェント設定ファイルを手動で作成または編集する - Amazon CloudWatch](https://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/latest/monitoring/CloudWatch-Agent-Configuration-File-Details.html)

## クロスアカウントオブザーバビリティ (Cross Account Observability)

複数アカウントにまたがった[[メトリクス]]やログを共有できるようになった。

- [[20230709211042|AWS Organizations]]を使用して、[[OU]]単位のアカウントをモニタリングアカウントに接続
- 個々のAWSアカウントをモニタリングアカウントに接続する

### 流れ

1. [[20230624175527|CloudWatch]]を共有したいアカウントで、`共有`で`特定アカウント`を選択して、**[[20230624175527|CloudWatch]]のデータを表示させたいアカウントIDを指定する**
2. 何を共有させたいのか、アクセス権限で調整
3. [[20230816170731|CloudFormation]]のテンプレート、スタックが作成されて共有できるようになる

[[Organizations]CloudWatchを別アカウントに共有する際にOrganization account selectorを使ってみた | DevelopersIO](https://dev.classmethod.jp/articles/cloudwatch-organizations-selector/)

## メトリクスの操作

### クライアントメトリクス

- **`PutMetricData API`を利用して、大量の[[メトリクス]]データをクライアント側から送信できる**
    - アプリケーションが[[メトリクス]] を送信できる権限が必要なので、上記の権限を付与すること
- [[CloudWatch Agent]]を活用して送信できる

### [[20240227235831|EC2インスタンス]]の[[メトリクス]]

- `StatusCheckFailed` ... インスタンスのステータスチェックとシステムのステータスチェックが1分ごと
- `StatusCheckFailed_Instance`と`StatusCheckFailed_System`もあるので注意

## こんなときは？

-  [[20240227235831|EC2インスタンス]]にインストールされた[[20230624175527|CloudWatch]]エージェントのエージェント設定は正しく、生成されるアプリケーションログファイルも正しいのに、特定の[[20240227235831|EC2インスタンス]]からのログファイルが配信されない
    - -> ログファイル自体は問題なく生成されているので、**何らかの原因で配信がされないということに注目**
        - 配信サービスである`awslogs`サービスが全ての[[20240227235831|EC2インスタンス]]で実行されていることを確認
        - エージェントが入っているかどうかやエージェントを使用する権限が正しいこと（ロググループ・ログストリームの作成とログイベントのpush）を確認
----

[20230727234718|EC2]: 20230727234718 "Amazon Elastic Compute Cloud (Amazon EC2)"
[20230730201034|ELB]: 20230730201034 "Elastic Load Balancing"
[20230802000730|RDS]: 20230802000730 "Amazon Relational Database Service (Amazon RDS)"
[20230709211042|AWS Organizations]: 20230709211042 "AWS Organizations"
[20230624175527|CloudWatch]: 20230624175527 "Amazon CloudWatch"
[20230816170731|CloudFormation]: 20230816170731 "AWS CloudFormation"
