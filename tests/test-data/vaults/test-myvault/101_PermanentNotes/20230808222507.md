---
title: Amazon EMR
aliases: [Amazon EMR,EMR,emr]
tags: [aws/analytics/emr,mapreduce,dea]
id: 20230808222507
date: 2023-08-08
publish: false
---

# Amazon EMR

- [[Apache Hadoop]]や[[20240827185154|Apache Spark]]などのビッグデータフレームワークを利用して、ビッグデータを処理・分析するマネージドクラスターサービス
- [[20240825163557|ビッグデータ処理]]については別ページ

## アーキテクチャ

- ストレージ
    - [[20240825162124|HDFS]]
        - ファイルをブロック単位で保存し、デフォルトのブロックサイズは128MB
        - **[[エフェメラルストレージ(Ephemeral Storage)]]であるため、クラスターが終了するとデータが消えることに注意**
        - 途中結果を[[20231118204104|キャッシュ]]したり、[[I/O]]が多いワークロードに適している
    - [[20240825164925|EMR File Storage(EMRFS)]]
        - HDFSなどのファイルシステムのように[[20230731234309|Amazon S3]]に保存されたデータを扱える
    - ローカル[[ファイルシステム(File System,FS)]]
    - [[20230727220035|EBS]]
        - ただし、[[20240825162124|HDFS]]のバックとして使用する
        - 基本的には[[20240825162124|HDFS]]と同じで、手動でボリュームをデタッチすると新しいものが付け替えられる
- クラスターリソース管理
    - [[20240227235831|EC2インスタンス]]をクラスターとして使用
        - インスタンスグループかインスタンスフリート構成を取ることができる
        - [[アップデート] 細かいことはまるっと任せた！Amazon EMR に新たなスケーリングオプション EMR マネージドスケーリング が追加されました！ | DevelopersIO](https://dev.classmethod.jp/articles/amazon-emr-now-supports-managed-scaling/#toc-5)
    - [[YARN(Yet Another Resource Negotiator)]]を使ってクラスターリソースを集中管理して [[Hadoop MapReduce]]を動作させる
        - マスターノード ... クラスターを管理する1つの[[20240227235831|EC2インスタンス]]からなるノード
        - コアノード ... [[20240825162124|HDFS]]データをホストし、タスクを実行する (データをホストするので、スケールアップやスケールダウンにリスクが伴う)。failしたら新しいノードがプロビジョンされる
        - タスクノード ... タスクを実行するだけのノード。[[スポットインスタンス]]を利用すことがおすすめ。ノードの追加・削除は即時行われる
    - [[スケールアップ]]
        - コアノードの追加、続いてタスクノードの追加
    - [[スケールダウン]]
        - タスクノードの削除、続いてコアノードの削除
            - 最初に[[スポットインスタンス]]、続いて[[オンデマンドインスタンス]]の順番で削除されていく
- データ処理フレームワーク
    - [[Apache Hadoop]]([[Hadoop MapReduce]])
    - [[20240827185154|Apache Spark]]
    - [[20240922133757|Presto]]
        - オープンソースの分散 SQL クエリエンジンで、低レイテンシーでアドホックなデータ分析用に最適化されている
- [[メタストア(metastore)]]
    - [[Apache Hive]]の外部[[メタストア(metastore)]]として下記のものが利用できる
        - プライマリノードのファイルシステムの[[MySQL]][[DB]] (デフォルトの動作)
        - [[20230921223315|AWS Glue Data Catalog]]
        - [[20230802000730|RDS]]または[[20230802000453|Aurora]]
- アプリケーションとプログラム
    - [[Apache Hive]]
    - [[Pig]]
    - [[Spark Streaming]]

## [[20230808222507|EMR]]の使い方

- 一時的にクラスターを起動する
    - 一定のプロセスが事前に定義されている場合、[[スポットインスタンス]]を活用してコストを抑えて実行する
- ロングランでクラスターを起動する
    - アドホックに分析を行う場合など、いつ分析が行われるかわからない場合、[[20240204173918|リザーブドインスタンス (RI)]]を活用してコストを抑えて実行する

### AWSの他のサービスとの連携

- [[20230731234309|S3]]に入力、出力データを保管し、[[20230726233418|IAM]]や[[20230806001024|VPC]]のプライベートサブネットなどでセキュリティを向上させ、[[20230624175527|CloudWatch]]でモニタリングし、[[20230731235433|CloudTrail]]でリクエストを監査、[[20230921230727|AWS Data Pipeline]]で[[20230808222507|EMR]]によるデータ処理をスケジューリング

### AWSの他のサービスとの使い分け

- [[20230806000656|Athena]] ... [[20230802000730|RDS]]や[[20230731234309|S3]]以外のデータソースがあり、同時実行クエリ数の制限を回避したい場合 [[20240922133757|Presto]] on [[20230808222507|EMR]]
- [[20230816164011|Glue]] ... [[20240701235015|ETL]]を行うときに[[スポットインスタンス]]を使いたい、処理を改善したい場合 [[Spark]] on [[20230808222507|EMR]]
- [[20230824214225|Amazon Kinesis Data Analytics]] ... ストリーミングデータを複雑に処理・カスタマイズしたい場合、[[Spark]] on [[20230808222507|EMR]]
- [[20230727010640|DynamoDB]] ... 既存の[[Apache HBase]]を使う場合、[[20230808222507|EMR]]

## ユースケース

EMRで[[HDFS]]を構成すれば、分析用の大規模データを蓄積するストレージとして機能することができる

[Hadoop関連の用語をざっくりまとめる【Hive, Presto, Spark】 - Qiita](https://qiita.com/tetsuro731/items/64abce51021c904bb7ab)

[Amazon EMR アーキテクチャの概要 - Amazon EMR](https://docs.aws.amazon.com/ja_jp/emr/latest/ManagementGuide/emr-overview-arch.html#emr-arch-storage)

## セキュリティ

- ストレージとして[[20230731234309|S3]]や[[20230727220035|EBS]]を使うので、どちらも[[20230817192133|KMS]]を使って暗号化できる
- アカウントレベルでブロックパブリックアクセス設定すれば、アカウントに作成された全ての[[20230808222507|EMR]]クラスターがデフォルトでパブリックアクセスできないようにできる

## [[ディープラーニングに適したインスタンスタイプ]]

- P3: 8 Tesla V100 GPU
- P2: 16 K80 GPU
- G3: 4 M60 GPU (all nvidia chips)
- G5g: [[AWS Graviton 2]] processor / nvidia T4G Tensor Core GPU
    - **まだ[[20230808222507|EMR]]では使えない**
- P4d: A100 "UltraClusters"
- Trn1: [[AWS Tranium]]を使っている([AI アクセラレーター - AWS Trainium - AWS](https://aws.amazon.com/jp/machine-learning/trainium/))
    - 800 Gbps の[[Elastic Fabric Adapter (EFA)]]
- Trn1n: Trn1よりもさらにネットワーク帯域を広げたもの 1600 Gbps
- Inf2: [[AWS Inferentia2]] ([コンピューティング - Amazon EC2 Inf2 インスタンス - AWS](https://aws.amazon.com/jp/ec2/instance-types/inf2/))

## こんなときは？

- [[20230808222507|EMR]]で[[Apache HBase]]を利用した高可用なアプリケーションを運用しているが、単一のマスターノードかつ[[20240825162124|HDFS]]にデータを保存している。さらに可用性を高めたい。費用対効果の高いソリューションは？
    - -> [[20240825162124|HDFS]]から[[20240825164925|EMRFS]]にし、さらにマスターノードを追加して、[[Apache HBase]]のルートディレクトリを[[20230731234309|S3]]バケットに変更する
        - [[20240825164925|EMRFS]]に変更することで、[[20230731234309|S3]]にデータが保存されるようになり可用性が高まる
        - マスターノードの追加により可用性が高まる
        - [[Apache HBase]]が[[20240825164925|EMRFS]]を利用できるようにルートディレクトリを変更する
        - [HBase Amazon S3 の (Amazon S3 ストレージモード） - Amazon EMR](https://docs.aws.amazon.com/ja_jp/emr/latest/ReleaseGuide/emr-hbase-s3.html)
- 複数のアナリストチームが[[20230808222507|EMR]]を使用して、各チームの[[20230731234309|S3]]バケットに保存されているデータをクエリしている。[[20230808222507|EMR]]クラスターは[[Active Directory]]による[[Kerberos]]認証が有効で、[[20230808222507|EMR]]や[[20230731234309|S3]]へのアクセスもチームメンバーのみに制限する
    - -> [[20230808222507|EMR]]クラスターの[[20240227235831|EC2インスタンス]]に対して、[[20230731234309|S3]]アクセスを許可しない[[サービスリンクロール]]をつけ、各チームごとの[[20230731234309|S3]]バケットへの許可を持つ[[20230818145809|IAMロール]]を作る。この[[20230726233418|IAM]]ロールの[[20240331180228|信頼ポリシー]]に[[20240227235831|EC2インスタンス]]の[[サービスリンクロール]]を追加するして、[[Active Directory]]から追加された[[20230818145809|IAMロール]]を引き受けられるようにする
        - [[20240227235831|EC2インスタンス]]からは直接[[20230731234309|S3]]バケットにアクセスできないようにする
        - チームごとに許可される[[20230731234309|S3]]へのアクセス許可を、[[20230808222507|EMR]]の[[20240227235831|EC2インスタンス]]が引き受けられるようにする
- [[20230731234309|S3]]や[[RDBMS]]([[20230802000453|Aurora]]とか)、[[20230808204558|OpenSearch Service]]や[[20240825162124|HDFS]]など様々なデータソースに対して、[[JDBC]]接続で対話型の[[SQL]]クエリを投げてデータセットを統合し**大規模な分析**を行いたい
    - -> [[20240922133757|Presto]] on [[20230808222507|EMR]]で行う
        - [[20230806000656|Athena]]も様々なデータソースや形式に対応している

---

[20230731234309|Amazon S3]: 20230731234309 "Amazon Simple Storage Service (Amazon S3)"

[20230731234309|S3]: 20230731234309 "Amazon Simple Storage Service (Amazon S3)"
[20230727220035|EBS]: 20230727220035 "Amazon Elastic Block Storage(EBS)"
[20230817192133|KMS]: 20230817192133 "AWS Key Management Service (AWS KMS)"
